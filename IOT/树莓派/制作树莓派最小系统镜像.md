## 准备
根据[[WSL2连接USB存储设备]]进行配置

**主机使用的是Debian12-wsl**

安装必要工具： 
```bash
sudo apt-get install dosfstools dump parted kpartx
```

建立工作目录
```bash
mkdir ~/backupimg
cd ~/backupimg
```

## 生成空白img文件
插入装有源SD卡的读卡器到USB口后，确定源SD卡对应的设备名
```bash
ls /dev/sd*
```

结果：`/dev/sda /dev/sdb /dev/sdc /dev/sdd /dev/sdd1 /dev/sdd2`

如上所示 `/dev/sdd` 为源SD卡， `/dev/sdd1` 为 `/boot`， `/dev/sdd2` 为 `/ （根）`，不同的系统会有所不同。

挂载源SD卡，注意`uid`和`gid`，需要替换
```bash
mkdir src_boot src_Root
sudo mount -t vfat -o uid=xuezhaorong,gid=xuezhaorong,umask=0000 /dev/sdd1 ./src_boot/
sudo mount -t ext4 /dev/sdd2 ./src_Root/

```

查看源SD卡已用空间大小
```bash
df -h
```

结果：
```bash
Filesystem                       Size  Used Avail Use% Mounted on
none                             3.9G  4.0K  3.9G   1% /mnt/wsl
drivers                          200G  171G   30G  86% /usr/lib/wsl/drivers
/dev/sdc                        1007G   13G  944G   2% /
none                             3.9G   88K  3.9G   1% /mnt/wslg
none                             3.9G     0  3.9G   0% /usr/lib/wsl/lib
rootfs                           3.9G  2.2M  3.9G   1% /init
none                             3.9G     0  3.9G   0% /dev
none                             3.9G  8.0K  3.9G   1% /run
none                             3.9G     0  3.9G   0% /run/lock
none                             3.9G     0  3.9G   0% /run/shm
none                             3.9G     0  3.9G   0% /run/user
tmpfs                            3.9G     0  3.9G   0% /sys/fs/cgroup
none                             3.9G   76K  3.9G   1% /mnt/wslg/versions.txt
none                             3.9G   76K  3.9G   1% /mnt/wslg/doc
C:\                              200G  171G   30G  86% /mnt/c
D:\                              276G  247G   30G  90% /mnt/d
F:\                              954G  398G  557G  42% /mnt/f
C:\Program Files\usbipd-win\WSL  200G  171G   30G  86% /run/usbipd-win
/dev/sde1                        510M   76M  435M  15% /home/xuezhaorong/backupimg/src_boot
/dev/sde2                         29G  5.6G   22G  21% /home/xuezhaorong/backupimg/src_Root
```

可以看到`/dev/sde`,大约为5.6G，可以设置空白img文件的大小为6G，保证不会出现问题。
```bash
sudo dd if=/dev/zero of=raspberrypi.img bs=1M count=6000
```

查看生成的镜像文件的大小
```bash
ls -l raspberrypi.img
```

结果：
```bash
-rw-r--r-- 1 root root 6291456000 Nov 16 00:47 raspberrypi.img
```

## 未空白镜像文件进行分区
```bash
sudo parted raspberrypi.img --script -- mklabel msdos
sudo parted raspberrypi.img --script -- mkpart primary fat32 8192s 172032s
sudo parted raspberrypi.img --script -- mkpart primary ext4 180224s -1
```

第二第三行命令是为`/boot`和`/`分区的命令，具体的计算方法如下：
需要根据`df -h`命令的`/dev/sde1`和`/dev/sde2`的使用大小(Used)，确定对应的内存
如`/dev/sde1`的使用内存为`76M`，起始扇区为8192，结束扇区的计算方式为：
$(结束扇区-8192) * 512 =76M=76*1048576字节$，算出结束扇区之后再向上取整，然后+8192保证充足空间，

`/dev/sde2`的起始扇区则需要在`/dev/sde1`的结束分区再+8192，结束扇区使用参数`-1`自动计算

检查镜像分区结果：
```bash
sudo parted raspberrypi.img
```

结果：
```bash
GNU Parted 3.5
Using /home/xuezhaorong/backupimg/raspberrypi.img
Welcome to GNU Parted! Type 'help' to view a list of commands.
(parted) print free
Model:  (file)
Disk /home/xuezhaorong/backupimg/raspberrypi.img: 6291MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
        16.4kB  4194kB  4178kB           Free Space
 1      4194kB  88.1MB  83.9MB  primary               lba
        88.1MB  92.3MB  4194kB           Free Space
 2      92.3MB  6290MB  6198MB  primary
        6290MB  6291MB  1049kB           Free Space

(parted) quit
```

在parted程序中，输入print free命令可以显示分区内容，输入quit退出

## 挂载img文件到系统
查询img文件对应的Loop device的设置
```bash
sudo losetup -f --show raspberrypi.img
```

结果：
```bash
/dev/loop0
```

以下步骤需要根据上面具体的`Loop device`进行具体的替换

loop device设置
```bash
sudo kpartx -va /dev/loop0
```
检查：
```bash
ls /dev/mapper/loop0p*
```

结果：
```bash
/dev/mapper/loop0p1  /dev/mapper/loop0p2
```

loop0p1对应的是img文件分区上的`/boot`，loop0p2对应的是 `/（根）`

接着给img文件中的两个分区格式化
```bash
sudo mkfs.vfat -n boot /dev/mapper/loop0p1
sudo mkfs.ext4 /dev/mapper/loop0p2
```


挂载目标img文件loop device，**需要注意`uid`和`gid`的替换**
```bash
mkdir tgt_boot tgt_Root
sudo mount -t vfat -o uid=xuezhaorong,gid=xuezhaorong,umask=0000 /dev/mapper/loop0p1 ./tgt_boot/
sudo mount -t ext4 /dev/mapper/loop0p2 ./tgt_Root/
```

## 备份
首先备份/boot，直接拷贝即可，需要等待一定时间
```bash
sudo cp -rfp ./src_boot/* ./tgt_boot/
```

